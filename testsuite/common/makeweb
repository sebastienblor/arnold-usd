#!/bin/sh
#
# this script assumes the user is running from inside the 'testsuite/common'
# directory
#

#
# let's dump everything in this directory.  This script does *not* clean-up the directory
# prior to copying everything so we might get old and stale files in there.
#
WEBDIR=$WEBDIR
PROJDIR=$PROJDIR
BANNER=http://www.spimageworks.com/people/arnold/arnold_banner.png
ARCH=$ARCH

#
# set file-creation mask so that everyone can overwrite
# this run at a later date
#
umask 0

# print help message
Help()
{
   /bin/echo "Arnold makeweb script"
   /bin/echo "Builds an HTML page with the results of the last run of the testsuite"
   /bin/echo "Usage: `basename $0` [OPTIONS]"
   /bin/echo ""
   /bin/echo "Available options:"
   /bin/echo "   -f           fast mode, don't rebuild/copy the images, just HTML"
   /bin/echo "   -q           quiet mode, supress verbosity"
   /bin/echo "   -t <path>    specify target directory (defaults to $WEBDIR)"
   exit 0
}

ParseCommandline()
{
   FAST=0
   QUIET=0
   while [ "$#" -gt "0" ]
   do
      if [ $1 = "help" ]; then
         Help
      fi
      if [ $1 = "-f" ]; then
         FAST=1
      fi
      if [ $1 = "-q" ]; then
         QUIET=1
      fi
      if [ $1 = "-t" ]; then
         shift
         WEBDIR=$1
	 /bin/echo "Using ${WEBDIR} ..."
      fi
      shift
   done
}


#####  EXECUTION STARTS HERE  ##########################################################

ParseCommandline $@

#
# this is the image resolution of the test images
#
SIZE=width=160 height=120
#
# this is the image rez of the thumbnails
#  (other useful resolutions: 80x60, 60x45, 40x30)
#
HSIZE=width=60 height=45

KICK=$KICK
DIFFTIFF=$DIFFTIFF
TIFF2JPEG=$TIFF2JPEG

#
# create an Arnold version string
#
ARNOLD="Arnold-`$KICK -av`-$ARCH"
FILETYPES=".ass .c* Makefile"
RED="bgcolor=#ffa0a0"
GREY="bgcolor=#ececec"

if [ ! -d $WEBDIR ]; then
   mkdir $WEBDIR
fi

cd $PROJDIR/testsuite
/bin/echo "<! generated by `basename $0` -- `date` -- $USER>"     >  $WEBDIR/index.html
/bin/echo "<html>"                                                >> $WEBDIR/index.html
/bin/echo "<head>"                                                >> $WEBDIR/index.html
/bin/echo "<title>$ARNOLD testsuite</title>"                      >> $WEBDIR/index.html
/bin/echo "<STYLE type=\"text/css\">"                             >> $WEBDIR/index.html
/bin/echo "<!-- A { text-decoration:none } -->"                   >> $WEBDIR/index.html
/bin/echo "</STYLE>"                                              >> $WEBDIR/index.html
/bin/echo "</head>"                                               >> $WEBDIR/index.html

/bin/echo ""                                                      >> $WEBDIR/index.html
/bin/echo "<body>"                                                >> $WEBDIR/index.html
/bin/echo "<font face=Arial>"                                     >> $WEBDIR/index.html
/bin/echo "<h2>testsuite results</h2>"                            >> $WEBDIR/index.html
/bin/echo "<pre>"                                                 >> $WEBDIR/index.html
/bin/echo "version : $ARNOLD"                                     >> $WEBDIR/index.html
/bin/echo "date    : `date`"                                      >> $WEBDIR/index.html
/bin/echo "user    : $USER"                                       >> $WEBDIR/index.html
/bin/echo "script  : `basename $0`"                               >> $WEBDIR/index.html
/bin/echo "tests   : `ls -d test_0* | wc -l`"                     >> $WEBDIR/index.html
TESTS=$(ls -d test*)
NUM_FAILED=0
for i in $TESTS
do
   if [ -f ${i}/FAILED ]; then
      NUM_FAILED=$((NUM_FAILED + 1))
   fi
done
/bin/echo "failed  : $NUM_FAILED"                                 >> $WEBDIR/index.html
/bin/echo "</pre>"                                                >> $WEBDIR/index.html
/bin/echo ""                                                      >> $WEBDIR/index.html
/bin/echo "<br><br>"                                              >> $WEBDIR/index.html
/bin/echo "<table border=0 cellpadding=0>"                        >> $WEBDIR/index.html
/bin/echo "<tr>"                                                  >> $WEBDIR/index.html
/bin/echo "<th>test</th>"                                         >> $WEBDIR/index.html
/bin/echo "<th>description</th>"                                  >> $WEBDIR/index.html
/bin/echo "<th>new</th>"                                          >> $WEBDIR/index.html
/bin/echo "<th>ref</th>"                                          >> $WEBDIR/index.html
/bin/echo "</tr>"                                                 >> $WEBDIR/index.html
/bin/echo ""                                                      >> $WEBDIR/index.html

TESTS=$(ls -d test*)
/bin/echo -n "processing $(/bin/echo $TESTS | wc -w) tests "
for i in $TESTS
do
   if [ $QUIET -eq "0" ]; then
      /bin/echo -n "."
   fi
   mkdir -p ${WEBDIR}/${i}
   for j in $FILETYPES
   do
      cp $i/data/*${j} ${WEBDIR}/${i}/ 2>/dev/null
   done

   FAILED=0
   COLOR=$GREY
   STATUS=OK
   if [ -f ${i}/FAILED ]; then
      FAILED=1
      COLOR=$RED
      STATUS=failed
   fi

   /bin/echo "<tr>"                                               >> $WEBDIR/index.html

   /bin/echo "<td $COLOR>"                                        >> $WEBDIR/index.html
   /bin/echo -n "<a href=${i}/test.html>"                         >> $WEBDIR/index.html
   /bin/echo "<center>&nbsp;$i&nbsp;</center></a>"                >> $WEBDIR/index.html
   /bin/echo "</td>"                                              >> $WEBDIR/index.html

   /bin/echo "<td $COLOR>"                                        >> $WEBDIR/index.html
   /bin/echo "&nbsp;"                                             >> $WEBDIR/index.html
   head -1 $i/README                                         >> $WEBDIR/index.html
   /bin/echo "&nbsp;"                                             >> $WEBDIR/index.html
   /bin/echo "</td>"                                              >> $WEBDIR/index.html

   if [ -f ${i}/ref/reference.tif ]; then
      /bin/echo "<td>"                                            >> $WEBDIR/index.html
      /bin/echo -n "<a href=${i}/test.html>"                      >> $WEBDIR/index.html
      /bin/echo "<img src=\"${i}/new.jpg\" border=0 $HSIZE></a>"  >> $WEBDIR/index.html
      /bin/echo "</td>"                                           >> $WEBDIR/index.html
      /bin/echo "<td>"                                            >> $WEBDIR/index.html
      /bin/echo -n "<a href=${i}/test.html>"                      >> $WEBDIR/index.html
      /bin/echo "<img src=\"${i}/ref.jpg\" border=0 $HSIZE></a>"  >> $WEBDIR/index.html
      /bin/echo "</a>"             >> $WEBDIR/index.html
      /bin/echo "</td>"                                           >> $WEBDIR/index.html
      if [ $FAST -eq "0" ]; then
         if [ -f ${i}/new/testrender.tif ]; then
             $TIFF2JPEG $i/new/testrender.tif $WEBDIR/${i}/new.jpg
             $TIFF2JPEG $i/ref/reference.tif  $WEBDIR/${i}/ref.jpg
             if [ $FAILED -eq "1" ]; then
                $DIFFTIFF -s -f $WEBDIR/${i}/diff.tif $i/new/testrender.tif $i/ref/reference.tif >/dev/null
                $TIFF2JPEG $WEBDIR/${i}/diff.tif $WEBDIR/${i}/diff.jpg
                rm $WEBDIR/${i}/diff.tif
             fi
        fi
      fi
   else
      /bin/echo "<td>"                                            >> $WEBDIR/index.html
      /bin/echo "<center>"                                        >> $WEBDIR/index.html
      /bin/echo "&nbsp;<br><b>no</b><br>&nbsp;"                   >> $WEBDIR/index.html
      /bin/echo "</center>"                                       >> $WEBDIR/index.html
      /bin/echo "</td>"                                           >> $WEBDIR/index.html
      /bin/echo "<td>"                                            >> $WEBDIR/index.html
      /bin/echo "<center>"                                        >> $WEBDIR/index.html
      /bin/echo "&nbsp;<br><b>image</b><br>&nbsp;"                >> $WEBDIR/index.html
      /bin/echo "</center>"                                       >> $WEBDIR/index.html
      /bin/echo "</td>"                                           >> $WEBDIR/index.html
   fi

   /bin/echo "</tr>"                                              >> $WEBDIR/index.html
   /bin/echo ""                                                   >> $WEBDIR/index.html

   TESTPAGE=$WEBDIR/${i}/test.html
   /bin/echo "<html>"                                             >  $TESTPAGE
   /bin/echo "<head>"                                             >> $TESTPAGE 
   /bin/echo "<title>$ARNOLD ${i}</title>"                        >> $TESTPAGE
   /bin/echo "</head>"                                            >> $TESTPAGE
   /bin/echo "<body>"                                             >> $TESTPAGE
   /bin/echo "<font face=Arial>"                                  >> $TESTPAGE
   /bin/echo "<table border=0 cellpadding=0>"                     >> $TESTPAGE
   /bin/echo "<tr>"                                               >> $TESTPAGE
   /bin/echo "<th>test</th>"                                      >> $TESTPAGE
   /bin/echo "<th>status</th>"                                    >> $TESTPAGE
   /bin/echo "<th>description</th>"                               >> $TESTPAGE
   /bin/echo "<th>new</th>"                                       >> $TESTPAGE
   /bin/echo "<th>ref</th>"                                       >> $TESTPAGE
   /bin/echo "<th>diff</th>"                                      >> $TESTPAGE
   /bin/echo "</tr>"                                              >> $TESTPAGE

   /bin/echo "<tr>"                                               >> $TESTPAGE

   /bin/echo "<td bgcolor=#ececec>"                               >> $TESTPAGE
   /bin/echo "<center>&nbsp;$i&nbsp;</center>"                    >> $TESTPAGE
   /bin/echo "</td>"                                              >> $TESTPAGE

   /bin/echo "<td $COLOR>"                                        >> $TESTPAGE
   /bin/echo "<center>&nbsp;<b>$STATUS</b>&nbsp;</center>"        >> $TESTPAGE
   /bin/echo "</td>"                                              >> $TESTPAGE

   /bin/echo "<td bgcolor=#ececec>"                               >> $TESTPAGE
   /bin/echo "&nbsp;"                                             >> $TESTPAGE
   /bin/echo "<pre>"                                              >> $TESTPAGE
   cat $i/README                                             >> $TESTPAGE
   /bin/echo "</pre>"                                             >> $TESTPAGE
   /bin/echo "&nbsp;"                                             >> $TESTPAGE
   /bin/echo "</td>"                                              >> $TESTPAGE

   /bin/echo "<td bgcolor=#ececec>"                               >> $TESTPAGE
   /bin/echo "<img src=new.jpg border=0 hspace=1 $SIZE>"          >> $TESTPAGE
   /bin/echo "</td>"                                              >> $TESTPAGE

   /bin/echo "<td bgcolor=#ececec>"                               >> $TESTPAGE
   /bin/echo "<img src=ref.jpg border=0 hspace=1 $SIZE>"          >> $TESTPAGE
   /bin/echo "</td>"                                              >> $TESTPAGE

   /bin/echo "<td bgcolor=#ececec>"                               >> $TESTPAGE
   if [ $FAILED -eq "1" ]; then
      /bin/echo "<img src=diff.jpg border=0 hspace=1 $SIZE>"      >> $TESTPAGE
   else
      /bin/echo "&nbsp;<b>no difference</b>&nbsp;"                >> $TESTPAGE
   fi
   /bin/echo "</td>"                                              >> $TESTPAGE

   /bin/echo "</tr>"                                              >> $TESTPAGE
   /bin/echo "</table>"                                           >> $TESTPAGE
   /bin/echo "<a href=.>link to files</a>"                        >> $TESTPAGE
   /bin/echo "</font>"                                            >> $TESTPAGE
   /bin/echo "</body>"                                            >> $TESTPAGE
   /bin/echo "</html>"                                            >> $TESTPAGE
done

/bin/echo "</table>"                                              >> $WEBDIR/index.html
/bin/echo "</font>"                                               >> $WEBDIR/index.html
/bin/echo "</body>"                                               >> $WEBDIR/index.html
/bin/echo "</html>"                                               >> $WEBDIR/index.html

/bin/echo ""
